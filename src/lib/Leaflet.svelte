<script lang="ts">
	import { onMount, onDestroy, setContext, createEventDispatcher, tick } from 'svelte';
	import L from 'leaflet';
	import 'leaflet/dist/leaflet.css';
	import 'leaflet-textpath'

	export let bounds: L.LatLngBoundsExpression | undefined = undefined;
	export let view: L.LatLngExpression | undefined = undefined;
	export let zoom: number | undefined = undefined;

	const dispatch = createEventDispatcher();

	let map: L.Map | undefined;
	let mapElement: HTMLElement;
	let showGroundTemps = true;

	function fToC(fahrenheit:number){
		let celsius = (fahrenheit - 32.0) * 5.0/9.0;
		
		return ""+Math.floor(celsius)+"Â°                                ";
	}
	
	export const isoTherms = {
"type": "FeatureCollection",
"name": "isoTherms1925",
"crs": { "type": "name", "properties": { "name": "urn:ogc:def:crs:OGC:1.3:CRS84" } },
"features": [
{ "type": "Feature", "properties": { "id": 1, "Temperature": 52 }, "geometry": { "type": "MultiLineString", "coordinates": [ [ [ -124.64292, 46.08022 ], [ -124.44958, 46.66003 ], [ -124.20614, 47.15727 ], [ -123.80319, 47.87379 ], [ -123.52454, 48.08755 ], [ -123.13261, 48.30337 ], [ -122.67493, 48.48421 ], [ -122.06638, 48.60366 ], [ -121.38112, 48.60125 ], [ -119.40323, 48.19963 ], [ -118.47697, 47.88388 ], [ -117.67121, 47.53252 ], [ -116.9896, 47.13906 ], [ -116.52674, 46.68223 ], [ -116.2727, 46.04761 ], [ -116.26817, 45.29501 ], [ -116.18198, 44.33717 ], [ -115.77976, 43.73823 ], [ -115.20516, 43.23798 ], [ -115.15489, 42.96528 ], [ -115.27699, 42.77578 ], [ -115.57865, 42.75996 ], [ -115.86595, 42.83901 ], [ -116.27535, 43.05982 ], [ -116.42618, 43.35299 ], [ -117.24498, 44.41931 ], [ -118.14997, 45.4363 ], [ -118.81076, 45.69276 ], [ -119.47873, 45.76796 ], [ -120.13233, 45.54204 ], [ -120.7213, 45.01644 ], [ -121.20252, 44.12617 ], [ -121.40363, 43.55633 ], [ -121.52677, 42.34507 ], [ -121.58321, 40.78262 ], [ -121.15224, 39.37124 ], [ -120.48427, 38.54466 ], [ -119.45, 37.94107 ], [ -117.54665, 37.46372 ], [ -115.83004, 37.34391 ], [ -113.39518, 37.71415 ], [ -111.83659, 38.28579 ], [ -111.12552, 38.71859 ], [ -110.28518, 39.39345 ], [ -109.83947, 39.79419 ], [ -109.12973, 39.95361 ], [ -108.89178, 39.50992 ], [ -109.04945, 38.83513 ], [ -109.71464, 37.984 ], [ -110.61047, 37.14528 ], [ -111.56365, 36.17004 ], [ -112.02333, 35.64064 ], [ -112.02887, 35.41062 ], [ -111.92996, 35.24273 ], [ -111.65236, 35.11247 ], [ -111.28072, 35.05935 ], [ -110.63806, 35.0992 ], [ -110.04097, 35.20752 ], [ -108.74813, 35.72231 ], [ -107.82877, 35.97266 ], [ -106.96688, 35.68732 ], [ -106.24863, 35.31309 ], [ -105.60221, 35.41266 ], [ -105.35801, 35.8272 ], [ -105.37955, 36.29171 ], [ -105.20717, 37.64025 ], [ -104.72551, 39.12417 ], [ -103.87243, 40.22244 ], [ -102.60832, 40.94971 ], [ -100.52062, 41.45408 ], [ -97.93493, 41.59747 ], [ -94.08513, 41.48278 ], [ -90.44123, 41.37867 ], [ -88.32, 41.48278 ], [ -86.45256, 41.63685 ], [ -83.84294, 41.67262 ], [ -82.78951, 41.61895 ], [ -81.52735, 41.46291 ], [ -80.41145, 41.22652 ], [ -79.69626, 40.9967 ], [ -79.34192, 40.61615 ], [ -79.39938, 40.09802 ], [ -79.83512, 39.56116 ], [ -80.2134, 39.10933 ], [ -80.40972, 38.85622 ], [ -80.39535, 38.5086 ], [ -79.83991, 38.29847 ], [ -79.25095, 38.44113 ], [ -78.54467, 38.77974 ], [ -77.86473, 39.34116 ], [ -77.16085, 39.84666 ], [ -76.04517, 40.50884 ], [ -74.6422, 41.02742 ], [ -72.89925, 41.27979 ], [ -70.30878, 41.05992 ] ] ] } },
{ "type": "Feature", "properties": { "id": 2, "Temperature": 37 }, "geometry": { "type": "MultiLineString", "coordinates": [ [ [ -107.15721, 51.19988 ], [ -103.03448, 50.23585 ], [ -99.42888, 49.39238 ], [ -96.11058, 48.743 ], [ -92.86411, 48.28625 ], [ -89.86184, 48.03713 ], [ -88.29115, 47.88517 ], [ -86.31773, 47.78446 ], [ -83.95785, 47.69985 ], [ -80.59774, 47.638 ], [ -78.80632, 47.59851 ], [ -74.45556, 47.7927 ], [ -72.34365, 47.71511 ], [ -66.01738, 47.52932 ] ] ] } },
{ "type": "Feature", "properties": { "id": 3, "Temperature": 42 }, "geometry": { "type": "MultiLineString", "coordinates": [ [ [ -112.72721, 50.11395 ], [ -107.4679, 49.31263 ], [ -104.25191, 48.6553 ], [ -100.45957, 47.31901 ], [ -99.50994, 46.87767 ], [ -98.35589, 46.55326 ], [ -96.36556, 46.2568 ], [ -93.69368, 46.10762 ], [ -91.09696, 45.92668 ], [ -89.41241, 45.83516 ], [ -87.67918, 45.81481 ], [ -86.19424, 45.7435 ], [ -84.56325, 45.65169 ], [ -82.3967, 45.4437 ], [ -80.88743, 45.35482 ], [ -79.35749, 45.34551 ], [ -77.83548, 45.51933 ], [ -76.55633, 45.81804 ], [ -72.50542, 45.86808 ], [ -69.8479, 45.77798 ], [ -67.52079, 45.6074 ] ] ] } },
{ "type": "Feature", "properties": { "id": 5, "Temperature": 47 }, "geometry": { "type": "MultiLineString", "coordinates": [ [ [ -117.49637, 49.42276 ], [ -116.01678, 48.32686 ], [ -115.68639, 47.62487 ], [ -115.61456, 45.61243 ], [ -115.54274, 44.75181 ], [ -114.82449, 43.96096 ], [ -114.23553, 43.84711 ], [ -113.63648, 43.94758 ], [ -112.84213, 44.02297 ], [ -112.28028, 43.85539 ], [ -111.9081, 43.354 ], [ -111.83885, 42.36427 ], [ -111.62334, 41.95101 ], [ -110.13434, 41.21048 ], [ -108.53984, 40.49882 ], [ -108.11607, 40.10443 ], [ -107.92215, 39.66075 ], [ -108.19508, 38.65552 ], [ -108.15917, 38.132 ], [ -107.7354, 37.63314 ], [ -107.03152, 37.53068 ], [ -106.42101, 37.67863 ], [ -105.88233, 38.2731 ], [ -105.65967, 39.21421 ], [ -105.58066, 39.83471 ], [ -105.48984, 40.52212 ], [ -105.22644, 41.26169 ], [ -105.07789, 42.03196 ], [ -105.24428, 43.01563 ], [ -104.27226, 44.30763 ], [ -102.9842, 44.87707 ], [ -100.54695, 44.76158 ], [ -98.57417, 44.28364 ], [ -96.33324, 43.73261 ], [ -94.36969, 43.65383 ], [ -91.82975, 43.73681 ], [ -88.88263, 43.67723 ], [ -86.90182, 43.65827 ], [ -85.7658, 43.58778 ], [ -84.77426, 43.42737 ], [ -83.29946, 43.12756 ], [ -82.3418, 42.86139 ], [ -81.84492, 42.74026 ], [ -80.86795, 42.7188 ], [ -79.90396, 42.72118 ], [ -78.96125, 42.82628 ], [ -76.34684, 43.16948 ], [ -73.73242, 43.23929 ], [ -71.56236, 43.22819 ], [ -69.40379, 43.31598 ] ] ] } },
{ "type": "Feature", "properties": { "id": 7, "Temperature": 42 }, "geometry": { "type": "MultiLineString", "coordinates": [ [ [ -107.62766, 38.75641 ], [ -107.57739, 39.04707 ], [ -107.44092, 39.74088 ], [ -107.39783, 40.50428 ], [ -106.9597, 40.72238 ], [ -106.44256, 40.17032 ], [ -106.29173, 39.82368 ], [ -106.25581, 39.38651 ], [ -106.25581, 39.09447 ], [ -106.27736, 38.7228 ], [ -106.35637, 38.48706 ], [ -106.7514, 38.26746 ], [ -107.09616, 38.25054 ], [ -107.31164, 38.32947 ], [ -107.52711, 38.44207 ], [ -107.62766, 38.7228 ] ] ] } },
{ "type": "Feature", "properties": { "id": 9, "Temperature": 57 }, "geometry": { "type": "MultiLineString", "coordinates": [ [ [ -123.54847, 38.15584 ], [ -123.53224, 38.37755 ], [ -123.56795, 39.08481 ], [ -123.81138, 40.32498 ], [ -123.86223, 41.53954 ], [ -123.84492, 41.72069 ], [ -123.78101, 41.90114 ], [ -123.68479, 42.04329 ], [ -123.52088, 42.13843 ], [ -123.31478, 42.14926 ], [ -123.12328, 42.13121 ], [ -122.97397, 42.0686 ], [ -122.67645, 41.83687 ], [ -122.2004, 41.1855 ], [ -122.17227, 41.05672 ], [ -122.10952, 40.98816 ], [ -122.04893, 40.82953 ], [ -121.98185, 40.65575 ], [ -121.74491, 39.942 ], [ -121.49607, 39.35721 ], [ -121.20503, 38.7987 ], [ -120.8407, 38.33364 ], [ -120.36546, 37.95735 ], [ -119.72453, 37.58143 ], [ -118.97195, 37.32682 ], [ -117.74289, 37.08554 ], [ -116.34938, 36.87119 ], [ -114.82603, 36.81578 ], [ -113.43252, 37.07863 ], [ -111.67548, 37.55017 ], [ -111.08692, 37.74891 ], [ -110.70284, 37.73351 ], [ -110.6455, 37.55703 ], [ -111.3033, 37.13731 ], [ -111.84859, 36.84003 ], [ -112.10825, 36.65277 ], [ -112.44581, 36.38845 ], [ -112.86992, 35.96927 ], [ -113.20748, 35.25153 ], [ -112.8353, 34.82277 ], [ -111.92649, 34.24523 ], [ -111.19944, 34.00879 ], [ -109.79978, 33.82015 ], [ -108.51195, 33.97291 ], [ -107.50793, 34.06617 ], [ -106.41735, 33.82564 ], [ -105.80521, 33.92175 ], [ -105.21124, 34.89608 ], [ -105.04078, 35.34385 ], [ -104.76306, 36.03609 ], [ -104.23634, 36.67622 ], [ -103.31699, 37.13568 ], [ -101.58362, 37.57718 ], [ -100.46316, 37.88771 ], [ -98.25096, 38.16683 ], [ -96.89094, 38.22968 ], [ -94.84611, 38.27605 ], [ -92.00185, 38.48773 ], [ -89.93322, 38.66366 ], [ -88.09539, 38.6923 ], [ -86.05562, 38.7042 ], [ -84.42471, 38.55168 ], [ -83.68732, 38.40174 ], [ -82.83725, 38.03272 ], [ -82.33092, 37.7407 ], [ -82.19459, 37.37017 ], [ -82.49024, 36.49359 ], [ -81.95395, 36.24683 ], [ -81.0456, 36.76414 ], [ -79.84709, 37.3891 ], [ -79.0235, 37.96514 ], [ -78.3292, 38.33041 ], [ -77.5487, 38.71626 ], [ -76.80173, 39.03312 ], [ -75.42269, 39.41889 ], [ -73.47385, 39.38559 ] ] ] } },
{ "type": "Feature", "properties": { "id": 10, "Temperature": 62 }, "geometry": { "type": "MultiLineString", "coordinates": [ [ [ -119.76716, 33.78698 ], [ -121.42034, 36.78546 ], [ -122.80195, 38.68478 ], [ -123.25635, 39.54727 ], [ -123.42181, 40.11607 ], [ -123.51991, 40.40119 ], [ -123.56308, 40.70621 ], [ -123.54306, 40.91094 ], [ -123.48096, 41.02989 ], [ -123.43047, 41.09841 ], [ -123.34724, 41.14763 ], [ -123.22714, 41.18061 ], [ -123.09082, 41.15985 ], [ -122.97397, 41.10117 ], [ -122.78247, 40.93097 ], [ -122.48603, 40.59334 ], [ -122.17443, 39.8266 ], [ -121.8838, 39.15951 ], [ -121.65498, 38.83979 ], [ -121.24114, 38.31455 ], [ -120.75063, 37.85833 ], [ -119.99573, 37.22159 ], [ -119.1786, 36.79932 ], [ -117.85433, 36.33356 ], [ -116.38292, 36.01916 ], [ -114.82495, 35.66132 ], [ -113.8469, 35.13216 ], [ -112.89481, 34.39267 ], [ -112.07918, 33.86046 ], [ -111.32778, 33.40645 ], [ -110.61209, 33.13372 ], [ -109.9057, 32.94262 ], [ -108.77986, 32.83014 ], [ -108.15667, 32.86287 ], [ -107.58816, 32.90243 ], [ -105.69997, 33.28627 ], [ -104.66132, 33.52712 ], [ -103.12644, 34.04506 ], [ -101.88007, 34.6928 ], [ -100.06821, 35.4108 ], [ -98.16403, 35.85165 ], [ -96.47667, 36.06028 ], [ -94.86678, 36.12323 ], [ -93.30016, 36.04628 ], [ -90.94157, 35.76937 ], [ -88.69551, 35.34689 ], [ -86.65284, 34.8867 ], [ -85.6591, 34.67387 ], [ -84.71945, 34.59108 ], [ -83.71976, 34.67254 ], [ -82.68869, 34.8867 ], [ -80.49888, 35.50876 ], [ -78.61201, 36.09176 ], [ -76.94836, 36.54956 ], [ -75.58264, 36.76032 ] ] ] } },
{ "type": "Feature", "properties": { "id": 11, "Temperature": 67 }, "geometry": { "type": "MultiLineString", "coordinates": [ [ [ -116.23578, 31.91479 ], [ -116.31793, 32.36805 ], [ -116.50409, 32.79218 ], [ -117.17056, 33.58172 ], [ -118.19189, 34.19245 ], [ -118.75449, 34.60667 ], [ -119.22188, 34.91243 ], [ -119.53347, 35.26654 ], [ -119.74985, 35.59801 ], [ -119.85372, 35.90006 ], [ -119.85372, 36.06815 ], [ -119.68926, 36.29171 ], [ -119.1786, 36.34053 ], [ -118.38771, 36.11449 ], [ -117.58385, 35.88316 ], [ -116.43736, 35.44628 ], [ -115.968, 35.25771 ], [ -115.20579, 34.89113 ], [ -113.8469, 34.30692 ], [ -112.46204, 33.50236 ], [ -111.87997, 33.07595 ], [ -110.76992, 32.47283 ], [ -109.79727, 31.97263 ], [ -107.55553, 30.90185 ], [ -107.13426, 29.12879 ], [ -107.01741, 28.53167 ], [ -106.5695, 28.03433 ], [ -105.80999, 27.87952 ], [ -104.91416, 27.98275 ], [ -104.3494, 28.46321 ], [ -102.93392, 30.12711 ], [ -102.05864, 31.03025 ], [ -100.83664, 31.94047 ], [ -99.31396, 32.70119 ], [ -97.4561, 33.19142 ], [ -94.15217, 33.20744 ], [ -89.50751, 32.87831 ], [ -86.76859, 32.81394 ], [ -83.00498, 32.80589 ], [ -80.32353, 33.0069 ], [ -78.00599, 33.44749 ] ] ] } },
{ "type": "Feature", "properties": { "id": 12, "Temperature": 72 }, "geometry": { "type": "MultiLineString", "coordinates": [ [ [ -115.7078, 32.24481 ], [ -116.36561, 33.26386 ], [ -117.06669, 34.0061 ], [ -117.77643, 34.4712 ], [ -118.10858, 34.70456 ], [ -118.23679, 34.88315 ], [ -118.17458, 35.07551 ], [ -117.97713, 35.17153 ], [ -117.69475, 35.19805 ], [ -117.33501, 35.15339 ], [ -115.38755, 34.59954 ], [ -113.59589, 33.71861 ], [ -112.37549, 32.77763 ], [ -111.30222, 31.26599 ], [ -109.79619, 28.6948 ], [ -108.04956, 26.8244 ], [ -106.03145, 26.04565 ], [ -104.48572, 25.96966 ], [ -103.41462, 26.3193 ], [ -102.92776, 26.85916 ], [ -102.2072, 27.43103 ], [ -101.27717, 28.26295 ], [ -100.47273, 29.14491 ], [ -99.29481, 29.62056 ], [ -98.24138, 29.50394 ], [ -97.31245, 28.79302 ], [ -96.8815, 27.40764 ], [ -95.58585, 27.08479 ], [ -93.42417, 27.37916 ], [ -91.04828, 28.39471 ], [ -88.57501, 28.9074 ], [ -86.72492, 29.19682 ], [ -84.36486, 29.55393 ], [ -82.62192, 29.66217 ], [ -80.76405, 29.41221 ], [ -79.96919, 29.25359 ] ] ] } },
{ "type": "Feature", "properties": { "id": 13, "Temperature": 77 }, "geometry": { "type": "MultiLineString", "coordinates": [ [ [ -82.80387, 26.44281 ], [ -80.94601, 26.22824 ], [ -79.34671, 26.2626 ] ] ] } },
{ "type": "Feature", "properties": { "id": 15, "Temperature": 42 }, "geometry": { "type": "MultiLineString", "coordinates": [ [ [ -111.52655, 45.63545 ], [ -111.2293, 45.6304 ], [ -110.99127, 45.59206 ], [ -110.7244, 45.46472 ], [ -110.44599, 45.32797 ], [ -109.9895, 44.88046 ], [ -109.50109, 44.21504 ], [ -109.31069, 43.92565 ], [ -109.18985, 43.57324 ], [ -109.20683, 43.30739 ], [ -109.30956, 43.04013 ], [ -109.46937, 42.83529 ], [ -109.7836, 42.73842 ], [ -110.1041, 42.72518 ], [ -110.37735, 42.86841 ], [ -111.02377, 43.58018 ], [ -111.56485, 44.43085 ], [ -111.88567, 45.02278 ], [ -111.86173, 45.47115 ], [ -111.52655, 45.6321 ] ] ] } },
{ "type": "Feature", "properties": { "id": 16, "Temperature": 52 }, "geometry": { "type": "MultiLineString", "coordinates": [ [ [ -112.8046, 42.01376 ], [ -112.48327, 41.97033 ], [ -112.1894, 41.83767 ], [ -111.93474, 41.52962 ], [ -111.86049, 41.3002 ], [ -111.75947, 41.06386 ], [ -111.7999, 40.80087 ], [ -112.26297, 40.48563 ], [ -112.5774, 40.40474 ], [ -112.97271, 40.41318 ], [ -113.31743, 40.43933 ], [ -113.61753, 40.64344 ], [ -113.78158, 40.85552 ], [ -113.82093, 41.16677 ], [ -113.78482, 41.38854 ], [ -113.68245, 41.60834 ], [ -113.52192, 41.78909 ], [ -113.32325, 41.92789 ], [ -112.95715, 42.00893 ] ] ] } },
{ "type": "Feature", "properties": { "id": 17, "Temperature": 52 }, "geometry": { "type": "MultiLineString", "coordinates": [ [ [ -118.77612, 40.59416 ], [ -118.60234, 40.51402 ], [ -118.49848, 40.38929 ], [ -118.39786, 40.2346 ], [ -118.35079, 40.04851 ], [ -118.35201, 39.89387 ], [ -118.39299, 39.72599 ], [ -118.47319, 39.56103 ], [ -118.60396, 39.4521 ], [ -118.77612, 39.36391 ], [ -118.94639, 39.33546 ], [ -119.1483, 39.35387 ], [ -119.36672, 39.38063 ], [ -119.58107, 39.53434 ], [ -119.68318, 39.72973 ], [ -119.73687, 39.96688 ], [ -119.6848, 40.25442 ], [ -119.62476, 40.39918 ], [ -119.50628, 40.50908 ], [ -119.24176, 40.61141 ], [ -119.07947, 40.63236 ], [ -118.90907, 40.6225 ] ] ] } }
]
	};

	onMount(() => {
		if (!bounds && (!view || !zoom)) {
			throw new Error('Must set either bounds, or view and zoom.');
		}

		map = L.map(mapElement)
			// example to expose map events to parent components:
			.on('zoom', (e) => dispatch('zoom', e))
			.on('popupopen', async (e) => {
				await tick();
				e.popup.update();
			});

		L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
			attribution: `&copy;<a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a>,&copy;<a href="https://carto.com/attributions" target="_blank">CARTO</a>`
		}).addTo(map);

		var myStyle = {
			"color": "red",
			"weight": 1,
			"opacity": 0.65,
		};


		if (showGroundTemps) {


			L.geoJSON(isoTherms.features, {
				style: myStyle,
				onEachFeature: function (feature, layer) {
            		layer.setText(fToC(feature.properties.Temperature), {repeat: true});
        }
			}).addTo(map);

			// var imageUrl = 'groundTempMapClearWithNumbers.png';
			// var altText =
			// 	'Average shallow ground water Temperaturees in the United States by Collins, 1925';

			// var latLngBounds = L.latLngBounds([
			// 	[50, -128.79],
			// 	[26.12, -62.75]
			// ]);

			// var imageOverlay = L.imageOverlay(imageUrl, latLngBounds, {
			// 	opacity: 0.8,
			// 	alt: altText,
			// 	interactive: false
			// }).addTo(map);
		}
		// console.log("map mounted")
	});

	onDestroy(() => {
		map?.remove();
		map = undefined;
	});

	setContext('map', {
		getMap: () => map
	});

	$: if (map) {
		if (bounds) {
			map.fitBounds(bounds);
		} else if (view && zoom) {
			map.setView(view, zoom);
		}
	}
</script>

<!-- w-full h-full -->
<div class="leafletDiv" bind:this={mapElement}>
	{#if map}
		<slot />
	{/if}
</div>

<style>
	.leafletDiv {
		height: 300px;
		/* width: 600px; */
	}
</style>
