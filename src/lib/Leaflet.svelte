<script lang="ts">
	import { onMount, onDestroy, setContext, createEventDispatcher, tick } from 'svelte';
	import L from 'leaflet';
	import 'leaflet/dist/leaflet.css';
	import 'leaflet-textpath'

	export let bounds: L.LatLngBoundsExpression | undefined = undefined;
	export let view: L.LatLngExpression | undefined = undefined;
	export let zoom: number | undefined = undefined;

	const dispatch = createEventDispatcher();

	let map: L.Map | undefined;
	let mapElement: HTMLElement;
	let showGroundTemps = true;

	function fToC(fahrenheit:number){
		let celsius = (fahrenheit - 32.0) * 5.0/9.0;
		
		return ""+Math.floor(celsius)+"Â°                                ";
	}
	
	export const isoTherms = {
	"type": "FeatureCollection",
	"name": "isoTherms1925",
	"crs": { "type": "name", "properties": { "name": "urn:ogc:def:crs:OGC:1.3:CRS84" } },
	"features": [
		{ "type": "Feature", "properties": { "id": 1, "Temperature": 52 }, "geometry": { "type": "MultiLineString", "coordinates": [[[-124.642921247946376, 46.080221499111047], [-124.211973416501237, 47.270293555815876], [-123.838485295915461, 47.909700637421231], [-122.674926151013636, 48.484207810720314], [-121.367717728963427, 48.636322332680272], [-119.356627848886205, 48.255177961352288], [-117.561011884531538, 47.52311381582485], [-116.526737089063261, 46.682229522501046], [-116.225073607051684, 46.03785722903406], [-116.268168390196195, 45.295009057344409], [-116.181978823907173, 44.337173852968199], [-115.779760847891723, 43.738233341861552], [-115.205163739298229, 43.237981665484895], [-115.154886492296299, 42.965282707150607], [-115.276988377872414, 42.775779774974929], [-115.57865185988399, 42.759961603233762], [-115.865950414180745, 42.839012065321121], [-116.275350854053613, 43.059815951019324], [-116.426182595059387, 43.352988584582654], [-117.244983474805125, 44.419311146682475], [-118.149973920839884, 45.436304044506926], [-118.810760595722414, 45.692755994991344], [-119.47872973446232, 45.767960250998883], [-120.132333945487431, 45.542043688754525], [-120.721295981795762, 45.016437821321759], [-121.202521060242788, 44.12617115352667], [-121.40363004825052, 43.556329842252417], [-121.526769433252397, 42.345073548788484], [-121.583212642870876, 40.782622957675216], [-121.152243813240844, 39.371243881676619], [-120.484274674500909, 38.544659931741293], [-119.449999879032632, 37.941072334173697], [-117.546646956816687, 37.463724316579722], [-115.830038094893624, 37.343907525277565], [-113.395182847228696, 37.714147148063283], [-111.83658819016884, 38.285787870377895], [-111.125524268284394, 38.718593594571573], [-110.285175996966416, 39.393450022642249], [-109.839465962149333, 39.794189205825759], [-109.129726525802724, 39.953611917973006], [-108.891778008627185, 39.509916319045395], [-109.049454088482506, 38.835130036802674], [-110.536562231976077, 37.080782891523157], [-111.563654563586937, 36.170042482958664], [-112.023332250461735, 35.64063542837026], [-111.929960220315294, 35.242728404532158], [-111.276356009290183, 35.025395306842412], [-110.040972225814187, 35.207524620712917], [-108.748128731478843, 35.722313030780377], [-107.828773357729247, 35.972656583671892], [-106.966877694838999, 35.687318582219696], [-106.248631309097135, 35.313090138106404], [-105.602209561929442, 35.412664560610047], [-105.358005790777213, 35.827204165576902], [-105.379553182349483, 36.291709641337867], [-105.207174049771425, 37.640246292404271], [-104.725507370142253, 39.124174568109218], [-103.872432849600756, 40.222441777235318], [-102.608319210695072, 40.949706346137738], [-100.520616382805372, 41.45407897090778], [-97.93492939413467, 41.597471031168105], [-94.08512876655827, 41.482782804009915], [-90.441225436227853, 41.378670953742173], [-88.3200044436702, 41.482782804009858], [-86.452563840741362, 41.636848127776567], [-83.842935305879237, 41.672624624248705], [-82.789507273457843, 41.618952427863043], [-81.527348216934243, 41.462913487313848], [-80.411454919234231, 41.226523805315885], [-79.69625950552954, 40.996704612984885], [-79.341924621896865, 40.616146927881623], [-79.399384332756242, 40.09802101595622], [-79.835120473439616, 39.56115512763558], [-80.213396903263686, 39.109328421182397], [-80.409717582033124, 38.856224678164914], [-80.395352654318273, 38.508604837838632], [-79.839908782677924, 38.298471658822798], [-79.250946746369578, 38.441128659668081], [-78.544671133723384, 38.779743922170631], [-77.864731221887752, 39.341161805530135], [-77.160849763860725, 39.846657794867447], [-76.04517371134169, 40.508835849272508], [-74.642199104525901, 41.027416145053955], [-72.899254541792303, 41.279789998318677], [-70.308779243883308, 41.059918632446632]]] } },
		{ "type": "Feature", "properties": { "id": 2, "Temperature": 37 }, "geometry": { "type": "MultiLineString", "coordinates": [[[-107.157212987060618, 51.199877472938674], [-103.034478732902301, 50.235852418706386], [-99.42888187647813, 49.39237967663567], [-96.110583574350713, 48.743004036924511], [-92.864109910797481, 48.286252726497111], [-89.861840018396478, 48.037125337914333], [-86.787745487421304, 47.863943506461233], [-83.957854727598345, 47.699849845971656], [-81.659466293224369, 47.622450041108586], [-73.841827965008591, 47.762569175456356], [-66.017383447236242, 47.529321646623337]]] } },
		{ "type": "Feature", "properties": { "id": 3, "Temperature": 42 }, "geometry": { "type": "MultiLineString", "coordinates": [[[-112.727213708488449, 50.113952998979357], [-107.467897601674082, 49.31262528100163], [-104.251906356734423, 48.655304488847136], [-100.459565440017371, 47.319007052398305], [-98.419745704510476, 46.652656513735892], [-96.365561041288728, 46.256803301523924], [-93.693684486329005, 46.107616353823346], [-91.03617285908409, 45.9680099252651], [-87.617320062952814, 45.767960250998854], [-84.557590459692463, 45.697772762382662], [-82.35975651932236, 45.516885587785076], [-79.357486626921357, 45.345512066511006], [-76.556325722528058, 45.81804016792762], [-72.50541610694394, 45.868075084383413], [-69.847904479699039, 45.777979834528949], [-67.520786189895404, 45.607402089147804]]] } },
		{ "type": "Feature", "properties": { "id": 5, "Temperature": 47 }, "geometry": { "type": "MultiLineString", "coordinates": [[[-117.496369709814445, 49.422757047620905], [-116.016782155186192, 48.32686044731954], [-115.686388817744927, 47.624870522037192], [-115.614564179170756, 45.612426507752915], [-115.542739540596571, 44.751808965681938], [-114.824493154854707, 43.96096053773794], [-114.235531118546376, 43.847110998117614], [-113.636479088664672, 43.947576507907456], [-112.842133130207145, 44.022968510688528], [-112.280277194463281, 43.855390481831293], [-111.908096758330316, 43.35399670933834], [-111.83885388649162, 42.364269078727858], [-111.623337945604447, 41.951009245597334], [-110.134344255960315, 41.210484052207619], [-108.53983727961338, 40.498823508932901], [-108.116071912025689, 40.104430590840217], [-107.922145387875389, 39.66075464292522], [-108.195079014457278, 38.655521292748574], [-108.1591666951702, 38.131997167928787], [-107.735401327582494, 37.633136562204648], [-107.031519869555467, 37.530681038887906], [-106.421010441674881, 37.678627078187688], [-105.882325652368465, 38.273101865162594], [-105.659669272788506, 39.214211945138956], [-105.580662170356902, 39.834708839041568], [-105.489842500392896, 40.522122306924501], [-105.22644085550651, 41.261688422697269], [-105.077889700337579, 42.031963599203124], [-105.244283446367746, 43.01563101883422], [-104.272256670997081, 44.307627619348686], [-102.984201485899973, 44.877065663881417], [-100.546952083615906, 44.76158452099282], [-98.574168677444916, 44.283637128526422], [-96.333239953930317, 43.732611257249872], [-94.369692251429541, 43.653833790962878], [-91.829747818596545, 43.736811300037928], [-88.882630779168011, 43.677227163756633], [-86.929000609950137, 43.746449285278246], [-84.774261452724488, 43.427365622797872], [-83.299462207334528, 43.127562625422776], [-82.3418003596787, 42.861391334019906], [-80.895730969718414, 42.678610065789705], [-78.961254037453656, 42.826282982570852], [-76.346837193353252, 43.169484271437447], [-73.732420349252877, 43.239289784028273], [-69.403788797848549, 43.315983583323906]]] } },
		{ "type": "Feature", "properties": { "id": 7, "Temperature": 42 }, "geometry": { "type": "MultiLineString", "coordinates": [[[-107.627664369721202, 38.756410283260884], [-107.577387122719273, 39.0470670194128], [-107.440920309428321, 39.740883351656805], [-107.39782552628381, 40.504284970754938], [-106.959695230981268, 40.72237868430247], [-106.442557833247122, 40.170322595766685], [-106.291726092241333, 39.823677188282879], [-106.255813772954241, 39.386511362530094], [-106.255813772954241, 39.094465020445575], [-106.277361164526496, 38.72279643765048], [-106.3563682669581, 38.487056812513423], [-106.751403779116146, 38.267462929127902], [-107.096162044272234, 38.25054349422475], [-107.311635959994774, 38.329467141232733], [-107.527109875717343, 38.442066261240882], [-107.627664369721202, 38.72279643765048]]] } },
		{ "type": "Feature", "properties": { "id": 9, "Temperature": 57 }, "geometry": { "type": "MultiLineString", "coordinates": [[[-123.78433119853878, 37.748907369122819], [-123.567947224042868, 39.084807563420149], [-123.862229429357313, 41.539541380904176], [-123.844918711397625, 41.720685499989408], [-123.593913300982379, 42.132816562185255], [-123.01833192882323, 42.058958012321462], [-122.676445249119681, 41.836866429962456], [-122.200400505228671, 41.185498638220587], [-122.172270588544208, 41.05672347732262], [-122.109519235940411, 40.988157880626282], [-122.048931723081537, 40.829531282709127], [-121.981852690987807, 40.6557518033798], [-121.744912238914765, 39.941999871647205], [-121.496070668244471, 39.357214498708856], [-121.205034222547397, 38.798697770572723], [-120.365464401503246, 37.957348790756413], [-118.971951605749524, 37.326818067756413], [-117.742890630612735, 37.085539371042664], [-116.349377834859027, 36.871191892880603], [-114.826034654407778, 36.815778453941945], [-113.432521858654056, 37.078634363864388], [-111.675483985747221, 37.550171091297642], [-111.08691957511833, 37.748907369122847], [-110.702838020388057, 37.733507210003403], [-110.645496267146669, 37.557032916881724], [-111.303303549614242, 37.137306873544652], [-111.848591165343962, 36.840026774504466], [-112.108251934739059, 36.6527693976481], [-112.445810934952689, 36.388448828589276], [-112.86992352496469, 35.969265740357379], [-113.207482525178307, 35.251525248875929], [-112.835302089045371, 34.822773738500139], [-111.926489396162509, 34.245232517177541], [-111.19943924185624, 34.008792098952895], [-109.799779655381187, 33.820153821950619], [-108.511950278616936, 33.972910147318274], [-107.507928636955882, 34.066171694444577], [-106.417353405496456, 33.825635855941783], [-105.805211428433012, 33.921746171948712], [-105.211237418441698, 34.896080990154587], [-105.04078030374086, 35.343854168893543], [-104.763058367920678, 36.03608692089108], [-104.236344351709974, 36.676218115830515], [-103.316988977960364, 37.135676176198857], [-101.583621033703338, 37.577182962707177], [-100.463156671946024, 37.887713178886308], [-98.250957803861084, 38.166828400415021], [-96.890942127666648, 38.229678355728112], [-94.846113568680281, 38.276049550021092], [-92.001853024578438, 38.487726415939541], [-89.933222228397469, 38.663658652226843], [-88.095385093568311, 38.692301771060158], [-86.055621405430628, 38.70419718894621], [-84.424714878330121, 38.551681548876907], [-83.687315255635141, 38.401738397193917], [-82.837254513317518, 38.03272129935354], [-82.330916012997065, 37.74069506930698], [-82.194594109064653, 37.37016699046228], [-82.490237946065378, 36.493585979886952], [-81.953947311378116, 36.246830707420116], [-81.045595204491335, 36.764139317841376], [-79.8470912465353, 37.389099052328206], [-79.023502057551283, 37.965142106551674], [-78.329197218000814, 38.330406191440659], [-77.548702812161324, 38.716258574948355], [-76.801726570989771, 39.033120373449592], [-75.422693510365406, 39.418885872873943], [-73.473851650385811, 39.385586155717569]]] } },
		{ "type": "Feature", "properties": { "id": 10, "Temperature": 62 }, "geometry": { "type": "MultiLineString", "coordinates": [[[-119.767162712022028, 33.786979186376456], [-121.420336277170847, 36.785457247903921], [-122.886682432894233, 38.643719495160227], [-123.490393721737831, 40.50488618346121], [-123.572274903532772, 40.924425919617285], [-123.208749826379645, 41.175727113440317], [-122.732705082488607, 40.914615541686686], [-122.48602735156328, 40.593342967967402], [-122.174434428289146, 39.826601931030233], [-121.6897343254183, 38.825674954675883], [-120.750627876106009, 37.858327178084792], [-119.178598301393151, 36.799319860171799], [-117.85432837747814, 36.333558988894893], [-116.382917350905885, 36.019161016902608], [-114.824952734535287, 35.661321173534645], [-113.846897169813758, 35.132161791540497], [-112.894807682031711, 34.392671561518675], [-111.332618642839606, 33.527362166572317], [-109.905702489832422, 32.942624587313894], [-107.588160818505358, 32.90243122272404], [-103.860039555468319, 33.581177407077689], [-100.3578138687039, 35.367285570839798], [-96.476673617154034, 36.060278988274895], [-94.866776846904401, 36.123226570085436], [-93.300156871553966, 36.046283791467836], [-90.941571549548456, 35.769369283674138], [-88.695505894280828, 35.346889672361044], [-86.652841175039384, 34.886697302423613], [-84.731351481515617, 34.630705324640005], [-82.688686762274173, 34.886697302423606], [-80.4988809403755, 35.508756000032832], [-78.612012682771095, 36.09175908103456], [-76.948364647411253, 36.549560996462418], [-75.582637039828242, 36.760324870280435]]] } },
		{ "type": "Feature", "properties": { "id": 11, "Temperature": 67 }, "geometry": { "type": "MultiLineString", "coordinates": [[[-116.235776248248641, 31.914787942705029], [-116.504092376623575, 32.792179383349513], [-117.170555018071013, 33.581717457626013], [-118.191887377691742, 34.192449062400058], [-118.754485711381122, 34.60666541082076], [-119.22187509629228, 34.912430258444701], [-119.533468019566428, 35.266543767137364], [-119.74985199406234, 35.598005554655771], [-119.85371630182037, 35.900060470724497], [-119.85371630182037, 36.068150192818862], [-119.689264481203494, 36.291712180445671], [-119.178598301393123, 36.34053127299611], [-118.408271352187654, 36.18699693556993], [-117.577356890123326, 35.815881419373859], [-116.430866553808585, 35.379006427527976], [-115.932838683954358, 35.266543767137364], [-115.205788529648075, 34.891134594156213], [-113.846897169813715, 34.306920350731197], [-112.462039733039859, 33.502362655808163], [-111.242716036755397, 32.77671644246476], [-109.797271087122667, 31.972627163273877], [-107.555533111344971, 30.901850260689461], [-105.768546210522317, 27.850966706206478], [-103.949045797413191, 28.625032238963019], [-102.933924238898015, 30.127106077251021], [-102.058642967789808, 31.030246940166666], [-100.836644792531771, 31.940469351502735], [-99.313962454759007, 32.701190869993845], [-97.456098470306713, 33.191415393901366], [-94.152165095894134, 33.207442243524078], [-89.507505134763406, 32.878306442882327], [-86.768592250467748, 32.813941594287733], [-83.00498118918037, 32.805892706683373], [-80.323528015744074, 33.006895980480259], [-78.005986344416968, 33.447492518297977]]] } },
		{ "type": "Feature", "properties": { "id": 12, "Temperature": 77 }, "geometry": { "type": "MultiLineString", "coordinates": [[[-115.707799350478624, 32.24480658261546], [-116.365606632946196, 33.263861681665468], [-117.066690710312983, 34.006101478199724], [-117.776430146659607, 34.471199744641524], [-118.105333787893386, 34.798789599970213], [-118.174576659732082, 35.075513426992956], [-117.741808710740258, 35.174622221479524], [-117.335006838687917, 35.153394776353274], [-115.387551068224667, 34.599541136283172], [-113.595891759398484, 33.718613077743214], [-112.375486143241517, 32.777626101622502], [-111.30222162974178, 31.265990887331377], [-109.796189167250105, 28.694796594552624], [-106.031452739534814, 26.045647533264976], [-102.681828814338019, 27.341829093564243], [-101.277169242453439, 28.26294915194196], [-100.472733290422553, 29.144911980237829], [-99.294809217805906, 29.62055756496515], [-98.241381185384498, 29.503938491648757], [-97.312449193158344, 28.793019534291158], [-96.881501361713234, 27.407638819460988], [-96.19198483140103, 26.305529104010343], [-84.364861012851634, 29.553934579500556], [-82.62191645011805, 29.662174582897798], [-80.764052465665756, 29.412214867735113], [-79.969193132111428, 29.25358809078298]]] } },
		{ "type": "Feature", "properties": { "id": 13, "Temperature": 77 }, "geometry": { "type": "MultiLineString", "coordinates": [[[-82.803872201172652, 26.442805994775643], [-80.946008216720372, 26.22823927705106], [-79.34671293113513, 26.262596663365763]]] } },
		{ "type": "Feature", "properties": { "id": 15, "Temperature": 42 }, "geometry": { "type": "MultiLineString", "coordinates": [[[-111.526545166989948, 45.635449334145889], [-110.521000226951315, 45.373689996572068], [-109.989497901502347, 44.880458666675352], [-109.501090359197875, 44.215038864039521], [-109.18985025870974, 43.573244081544047], [-109.309557989666729, 43.040133525013715], [-109.783600604256364, 42.73842482330938], [-110.377350949802945, 42.868410610050951], [-111.023772696970653, 43.580181882776074], [-111.56485164089618, 44.430852462739182], [-111.885668359860858, 45.022784109138861], [-111.861726813669492, 45.471152914063481], [-111.526545166989948, 45.632101147003127]]] } },
		{ "type": "Feature", "properties": { "id": 16, "Temperature": 52 }, "geometry": { "type": "MultiLineString", "coordinates": [[[-112.916446079481261, 42.027622451567353], [-112.189395925174992, 41.837672506010279], [-111.860492283941184, 41.300204828056721], [-111.799904771082339, 40.800872569627707], [-112.262966476503607, 40.485632990529368], [-112.972705912850188, 40.413180978293354], [-113.617530156848048, 40.643438889182313], [-113.820931092874176, 41.166768601691494], [-113.682445349196797, 41.608339030807095], [-113.323247951533588, 41.927888769034283], [-112.851530887132469, 42.024407674106527]]] } },
		{ "type": "Feature", "properties": { "id": 17, "Temperature": 52 }, "geometry": { "type": "MultiLineString", "coordinates": [[[-118.776124108830729, 40.594164515436347], [-118.386632954738062, 40.310956965595672], [-118.352011518818728, 39.893871826873067], [-118.473186544536446, 39.561033965663476], [-118.776124108830729, 39.363906565252996], [-119.148304544963693, 39.353868225015852], [-119.581072493955517, 39.53433755269527], [-119.736868955592598, 39.966880414393714], [-119.53779569905636, 40.528408823410508], [-118.905954493528256, 40.653289402295158]]] } }
	]
};


	onMount(() => {
		if (!bounds && (!view || !zoom)) {
			throw new Error('Must set either bounds, or view and zoom.');
		}

		map = L.map(mapElement)
			// example to expose map events to parent components:
			.on('zoom', (e) => dispatch('zoom', e))
			.on('popupopen', async (e) => {
				await tick();
				e.popup.update();
			});

		L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
			attribution: `&copy;<a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a>,&copy;<a href="https://carto.com/attributions" target="_blank">CARTO</a>`
		}).addTo(map);

		var myStyle = {
			"color": "gray",
			"weight": 1,
			"opacity": 0.65,
		};


		if (showGroundTemps) {


			L.geoJSON(isoTherms.features, {
				style: myStyle,
				onEachFeature: function (feature, layer) {
            		layer.setText(fToC(feature.properties.Temperature), {repeat: true});
        }
			}).addTo(map);

			// var imageUrl = 'groundTempMapClearWithNumbers.png';
			// var altText =
			// 	'Average shallow ground water temperatures in the United States by Collins, 1925';

			// var latLngBounds = L.latLngBounds([
			// 	[50, -128.79],
			// 	[26.12, -62.75]
			// ]);

			// var imageOverlay = L.imageOverlay(imageUrl, latLngBounds, {
			// 	opacity: 0.8,
			// 	alt: altText,
			// 	interactive: false
			// }).addTo(map);
		}
		// console.log("map mounted")
	});

	onDestroy(() => {
		map?.remove();
		map = undefined;
	});

	setContext('map', {
		getMap: () => map
	});

	$: if (map) {
		if (bounds) {
			map.fitBounds(bounds);
		} else if (view && zoom) {
			map.setView(view, zoom);
		}
	}
</script>

<!-- w-full h-full -->
<div class="leafletDiv" bind:this={mapElement}>
	{#if map}
		<slot />
	{/if}
</div>

<style>
	.leafletDiv {
		height: 300px;
		/* width: 600px; */
	}
</style>
